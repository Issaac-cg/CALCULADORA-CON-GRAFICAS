<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Derivadas Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.7.0/math.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<body class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto p-6">
        <div class="bg-white rounded-xl shadow-2xl p-8 mb-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Panel de Entrada -->
                <div class="lg:col-span-1">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Calculadora Pro Derivadas</h1>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Función:</label>
                            <input type="text" id="funcion" 
                                   class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                   placeholder="Ej: e^(2x)*sin(x^2)">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Variable:</label>
                            <input type="text" id="variable" value="x" 
                                   class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="calcularDerivada('formal')" 
                                    class="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-lg transition-colors">
                                Método Formal
                            </button>
                            <button onclick="calcularDerivada('directa')" 
                                    class="bg-teal-600 hover:bg-teal-700 text-white p-3 rounded-lg transition-colors">
                                Método Directo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Panel de Gráficos -->
                <div class="lg:col-span-2">
                    <div id="grafico" class="h-96 bg-gray-50 rounded-xl"></div>
                </div>
            </div>

            <!-- Historial de Cálculos -->
            <div class="mt-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Historial de Cálculos</h3>
                    <div class="space-x-3">
                        <button onclick="exportarHistorial()" 
                                class="text-purple-600 hover:text-purple-700 text-sm">
                            Exportar CSV
                        </button>
                        <button onclick="limpiarHistorial()" 
                                class="text-red-600 hover:text-red-700 text-sm">
                            Limpiar
                        </button>
                    </div>
                </div>
                <div id="historial" class="space-y-3 max-h-96 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <script>
        let historial = JSON.parse(localStorage.getItem('derivadasHistorial')) || [];

        function actualizarHistorial() {
            const contenedor = document.getElementById('historial');
            contenedor.innerHTML = historial.map((item, index) => `
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-sm text-gray-500">${new Date(item.timestamp).toLocaleString()}</span>
                        <span class="text-sm ${item.metodo === 'formal' ? 'text-purple-600' : 'text-teal-600'}">
                            ${item.metodo.toUpperCase()}
                        </span>
                    </div>
                    <div class="text-gray-700 space-y-1">
                        <p>\[ f(${item.variable}) = ${item.funcion} \]</p>
                        <p>\[ f'(${item.variable}) = ${item.derivada} \]</p>
                    </div>
                </div>
            `).join('');
        }

        function guardarEnHistorial(funcion, variable, derivada, metodo) {
            historial.unshift({
                funcion,
                variable,
                derivada,
                metodo,
                timestamp: new Date().getTime()
            });
            
            if(historial.length > 10) historial.pop();
            localStorage.setItem('derivadasHistorial', JSON.stringify(historial));
            actualizarHistorial();
        }

        function exportarHistorial() {
            const csvContent = "data:text/csv;charset=utf-8," 
                + historial.map(item => 
                    `${item.timestamp};${item.funcion};${item.variable};${item.derivada};${item.metodo}`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "historial_derivadas.csv");
            document.body.appendChild(link);
            link.click();
        }

        function limpiarHistorial() {
            historial = [];
            localStorage.removeItem('derivadasHistorial');
            actualizarHistorial();
        }

        // Funciones anteriores de cálculo y gráficos...
        
        function calcularDerivada(tipo) {
            try {
                const funcion = document.getElementById('funcion').value;
                const variable = document.getElementById('variable').value;
                const derivada = math.derivative(funcion, variable).toString();
                
                // Actualizar gráfico
                actualizarGrafico(funcion, derivada, variable);
                
                // Guardar en historial
                guardarEnHistorial(funcion, variable, derivada, tipo);
                
                MathJax.typeset();
            } catch (error) {
                alert(`Error: ${error.toString().replace('Error: ', '')}`);
            }
        }

        // Inicializar historial
        actualizarHistorial();
    </script>
</body>
</html>
